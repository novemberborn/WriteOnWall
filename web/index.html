<!doctype html>
<html>
<head>
<style>
html {
  font: 200%/1.2 Georgia;
  color:#FFF;
}
</style>
<script src="/socket.io.js"></script>
<script src="/dojotoolkit/dojo/dojo.js"></script>
<script>
dojo.require("dojo.fx");
dojo.registerModulePath("dojox", "/dojotoolkit/dojox");
dojo.registerModulePath("wow", "/wow");

dojo.require("wow.Anymeta");
var anymeta;
dojo.xhrGet({ url:"/oaa.json", handleAs:"json", sync:true}).then(function(oaa){
  anymeta = new wow.Anymeta("http://www.mediamatic.net/services/rest/", oaa);
});

var tags = {};
var labels = { like: "liked", made: "made", clear: "cleared" };

var socket = new io.Socket("localhost");
socket.connect();
socket.on("connect", function(){
  console.log("connected");
});
socket.on("message", function(msg){
  msg = JSON.parse(msg);
  console.log("socket message:", msg);
  
  if(msg.type == "tag" && msg.state == "add"){
    var tag = tags[msg.data] || anymeta.get("identity.identify", { type: "rfid", raw: "urn:rfid:" + msg.data }).then(function(response){
      return tags[msg.data] = response;
    });
    dojo.when(tag, function(thing){
      var rendered = dojo.create("p", {
        innerHTML: thing.title + " " + labels[msg.id] + " this"
      }, "overlay");
      dojo.fadeIn({ node: rendered, start: 0 }).play();
      dojo.fadeOut({
        node: rendered,
        start: 1,
        end: 0,
        onEnd: function(){
          dojo.fx.wipeOut({
            node: rendered,
            onEnd: function(){
              dojo.destroy(rendered);
            }
          }).play();
        }
      }).play(2000);
    });
  }
});
</script>
</head>
<body>
  <div id="overlay"></div>
</body>
</html>